# ============================================================================
# GitHub Actions Workflow: Generate & Publish Java SDKs
# Convention:
# services/{service-name}/{service-name}-openapi.yaml
# ============================================================================

name: Generate & Publish Java SDKs

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      # ======================================================================
      # STEP 1: Checkout repository
      # ======================================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ======================================================================
      # STEP 2: Setup Java
      # ======================================================================
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: temurin

      # ======================================================================
      # STEP 3: Install OpenAPI Generator
      # ======================================================================
      - name: Install OpenAPI Generator CLI
        run: |
          npm install -g @openapitools/openapi-generator-cli
          openapi-generator-cli version

      # ======================================================================
      # STEP 4: Detect changed OpenAPI files
      # ======================================================================
      - name: Detect changed OpenAPI files
        id: changes
        run: |
          echo "Detecting OpenAPI changes..."
          BEFORE="${{ github.event.before }}"

          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ] || [ -z "$BEFORE" ]; then
            echo "First push detected â€“ taking all OpenAPI files"
            git ls-files "services/*/*-openapi.y*ml" > changed_files.txt
          else
            git diff --name-status "$BEFORE" "${{ github.sha }}" \
              | awk '$1 != "D" { print $2 }' \
              | grep -E "^services/[^/]+/[^/]+-openapi\.ya?ml$" \
              > changed_files.txt || true
          fi

          if [ ! -s changed_files.txt ]; then
            echo "No OpenAPI files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "OpenAPI files detected:"
            cat changed_files.txt
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # ======================================================================
      # STEP 5: Validate OpenAPI specs
      # ======================================================================
      - name: Validate OpenAPI specifications
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          npm install -g @apidevtools/swagger-cli
          while IFS= read -r file; do
            echo "Validating $file"
            swagger-cli validate "$file"
          done < changed_files.txt

      # ======================================================================
      # STEP 6: Generate SDKs (Java 8, 11, 17, 21)
      # ======================================================================
      - name: Generate Java SDKs
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          mkdir -p generated
          JAVA_VERSIONS=("8" "11" "17" "21")

          while IFS= read -r file; do
            SERVICE=$(basename "$file" | sed 's/-openapi\.ya\?ml//')

            VERSION=$(grep -E '^[[:space:]]*version:' "$file" \
              | head -n 1 \
              | sed 's/^[^:]*:[[:space:]]*//')
            if [ -z "$VERSION" ]; then
              echo "âŒ ERROR: info.version is missing in $file"
              exit 1
            fi

            echo "Generating SDKs for $SERVICE (version $VERSION)"

            for JAVA_VER in "${JAVA_VERSIONS[@]}"; do
              if [ "$JAVA_VER" = "8" ]; then
                PROPS="java8=true,dateLibrary=java8,library=jersey2"
              else
                PROPS="java8=false,dateLibrary=java8,library=jersey2"
              fi

              openapi-generator-cli generate \
                -i "$file" \
                -g java \
                -o "generated/${SERVICE}-java${JAVA_VER}" \
                --additional-properties=groupId=com.harsh.openapi.${SERVICE},artifactId=${SERVICE}-sdk-java${JAVA_VER},artifactVersion=${VERSION},${PROPS},hideGenerationTimestamp=true
            done
          done < changed_files.txt

      # ======================================================================
      # STEP 7: Configure Maven settings
      # ======================================================================
      - name: Configure Maven settings
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${GITHUB_ACTOR}</username>
                <password>${GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

      # ======================================================================
      # STEP 8: Publish SDKs to GitHub Packages
      # ======================================================================
      - name: Build & Publish SDKs
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for dir in generated/*; do
            echo "Publishing $(basename "$dir")"
            cd "$dir"
            mvn clean deploy -DskipTests -Drevision=$(grep -m1 '<version>' pom.xml | sed 's/.*>\(.*\)<.*/\1/')
            cd -
          done

      # ======================================================================
      # STEP 9: Summary
      # ======================================================================
      - name: Summary
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "## ðŸš€ SDK Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          while IFS= read -r file; do
            SERVICE=$(basename "$file" | sed 's/-openapi\.ya\?ml//')
            VERSION=$(grep -A 1 "^info:" "$file" | grep "version:" | sed 's/.*version: *"\?\([^"]*\)"\?/\1/')

            echo "### ðŸ“¦ $SERVICE (v$VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "| Java | Artifact |" >> $GITHUB_STEP_SUMMARY
            echo "|------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| 8 | ${SERVICE}-sdk-java8 |" >> $GITHUB_STEP_SUMMARY
            echo "| 11 | ${SERVICE}-sdk-java11 |" >> $GITHUB_STEP_SUMMARY
            echo "| 17 | ${SERVICE}-sdk-java17 |" >> $GITHUB_STEP_SUMMARY
            echo "| 21 | ${SERVICE}-sdk-java21 |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done < changed_files.txt
