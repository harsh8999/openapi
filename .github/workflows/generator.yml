# ============================================================================
# GitHub Actions Workflow: Generate & Publish Java SDKs
# Convention:
# services/{service-name}/{service-name}-openapi.yaml
# ============================================================================

name: Generate & Publish Java SDKs

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      # ----------------------------------------------------------------------
      # STEP 1: Checkout repository
      # ----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # ----------------------------------------------------------------------
      # STEP 2: Setup Java
      # ----------------------------------------------------------------------
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: temurin

      # ----------------------------------------------------------------------
      # STEP 3: Install OpenAPI Generator
      # ----------------------------------------------------------------------
      - name: Install OpenAPI Generator CLI
        run: |
          npm install -g @openapitools/openapi-generator-cli
          openapi-generator-cli version

      # ----------------------------------------------------------------------
      # STEP 4: Detect changed OpenAPI files
      # ----------------------------------------------------------------------
      - name: Detect changed OpenAPI files
        id: changes
        run: |
          echo "Detecting OpenAPI changes..."
          BEFORE="${{ github.event.before }}"

          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ] || [ -z "$BEFORE" ]; then
            git ls-files "services/*/*-openapi.y*ml" > changed_files.txt
          else
            git diff --name-only "$BEFORE" "${{ github.sha }}" \
              | grep -E "^services/[^/]+/[^/]+-openapi\.ya?ml$" \
              > changed_files.txt || true
          fi

          if [ ! -s changed_files.txt ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            cat changed_files.txt
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------------------------------------------
      # STEP 5: Validate OpenAPI specs
      # ----------------------------------------------------------------------
      - name: Validate OpenAPI specs
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          npm install -g @apidevtools/swagger-cli
          while read file; do
            swagger-cli validate "$file"
          done < changed_files.txt

      # ----------------------------------------------------------------------
      # STEP 6: Generate Java SDKs (8, 11, 17, 21)
      # ----------------------------------------------------------------------
      - name: Generate Java SDKs
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          mkdir -p generated
          JAVA_VERSIONS=("8" "11" "17" "21")

          while read file; do
            SERVICE=$(basename "$file" | sed 's/-openapi\.ya\?ml//')

            VERSION=$(grep -E '^[[:space:]]*version:' "$file" | head -n1 | awk '{print $2}')
            if [ -z "$VERSION" ]; then
              echo "âŒ info.version missing in $file"
              exit 1
            fi

            echo "Generating SDKs for $SERVICE v$VERSION"

            for JAVA_VER in "${JAVA_VERSIONS[@]}"; do
              if [ "$JAVA_VER" = "8" ]; then
                PROPS="java8=true,dateLibrary=java8,library=jersey2"
              else
                PROPS="java8=false,dateLibrary=java8,library=jersey2"
              fi

              openapi-generator-cli generate \
                -i "$file" \
                -g java \
                -o "generated/${SERVICE}-java${JAVA_VER}" \
                --additional-properties=groupId=com.harsh.openapi.${SERVICE},artifactId=${SERVICE}-sdk-java${JAVA_VER},artifactVersion=${VERSION},${PROPS},hideGenerationTimestamp=true
            done
          done < changed_files.txt

      # ----------------------------------------------------------------------
      # STEP 7: Configure Maven auth
      # ----------------------------------------------------------------------
      - name: Configure Maven settings
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${GITHUB_ACTOR}</username>
                <password>${GITHUB_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

      # ----------------------------------------------------------------------
      # STEP 8: Build & Publish SDKs (FIXED)
      # ----------------------------------------------------------------------
      - name: Build & Publish SDKs
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for dir in generated/*; do
            echo "Publishing $(basename "$dir")"
            cd "$dir"

            mvn clean deploy -DskipTests \
              -DaltDeploymentRepository=github::https://maven.pkg.github.com/${{ github.repository }}

            cd -
          done

      # ----------------------------------------------------------------------
      # STEP 9: Summary
      # ----------------------------------------------------------------------
      - name: Summary
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "## ðŸš€ SDKs Published to GitHub Packages" >> $GITHUB_STEP_SUMMARY
          while read file; do
            SERVICE=$(basename "$file" | sed 's/-openapi\.ya\?ml//')
            VERSION=$(grep -E '^[[:space:]]*version:' "$file" | awk '{print $2}')
            echo "- **$SERVICE** â†’ v$VERSION (Java 8 / 11 / 17 / 21)" >> $GITHUB_STEP_SUMMARY
          done < changed_files.txt
